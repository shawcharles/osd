\section{Model}\label{sec:model}
Let $\mathcal{G}$ denote the set of experimental units (geos) and let $N := |\mathcal{G}|$.\footnote{If $\mathcal{G}$ is the set of DMAs in the US, $N=210$.} For each $g \in \mathcal{G}$, $S_g$ is a variable controlled by the researcher and $R_g$ is the response variable presumably affected by $S_g$. For advertising experiments, $S_g$ and $R_g$ correspond to the advertising spend and returns respectively. Following the Neymanâ€“Rubin causal framework \citep{imbens2015causal}, we use $(R_g^{(t)}, S_g^{(t)})$ and $(R_g^{(c)}, S_g^{(c)})$ to denote the potential outcomes under the treatment condition and the control condition, respectively. 

%\paragraph{Quantity of interest.}
The following ratio measures the unit-level causal effect of the treatment:
\begin{align*}
    \theta_g := \frac{R_g^{(t)} - R_g^{(c)}}{S_g^{(t)} - S_g^{(c)}},  \;\;\;\forall g \in \mathcal{G}.
\end{align*}
We are mainly interested in estimating the following ratio:
\begin{align*}
    \theta := \frac{\sum_g R_g^{(t)} - \sum_g R_g^{(c)}}{\sum_g S_g^{(t)} - \sum_g S_g^{(c)}},
\end{align*}
which measures the global causal response rate with respect to the controlled variable. In advertising experiments the quantity $\theta$ is often called the \emph{incremental return on ad spend} (iROAS)---the ratio of the additional return to the additional advertising spend \citep{chen2022robust}. If the response is measured in the same units (e.g.~USD) as the ad spend, $\theta>1$ indicates that it makes sense to expend an additional dollar on advertising.

\paragraph{Design and estimators.}
In practice we never observe both $(R_g^{(t)}, S_g^{(t)})$ and $(R_g^{(c)}, S_g^{(c)})$ since we can only assign a unit to either treatment or control. Let us use $\mathcal{T}$ and $\mathcal{C} \subseteq \mathcal{G}$ to denote the treatment and control groups in the experiment.
The standard way to estimate $\theta$ is to use an \emph{empirical estimator} that computes the ratio of differences between the treatment and control groups:
\begin{align}\label{eq:theta_hat}
\hat{\theta} := \frac{\sum_{g \in \mathcal{T}} R_g - \sum_{g \in \mathcal{C}} R_{g}}{\sum_{g \in \mathcal{T}} S_g - \sum_{g \in \mathcal{C}} S_{g}}.
\end{align}
The researcher might want to carefully choose the treatment group, $\mathcal{T}$, and the control group, $\mathcal{C}$, so that $\hat{\theta}$ is a good---in the statistical sense---estimate of $\theta$.\footnote{In the remainder of the paper we often refer to this experimental design stage as the \emph{pretest} phase as opposed to the \textit{test} phase which refers to the stage when the treatment is applied and the experimental data are collected and analyzed.}
%\Cliff{We should say here something about how our goal is to choose an $\mathcal{S}$ and $\mathcal{T}$ so that $\hat{\theta}$ is a good estimate of $\theta$.}\Shunhua{Done.}
% The experiment needs to be designed before the test starts and thus can only use data available in . We also refer to the actual experiment as the \textit{test} phase.
%The experiment consists of two phases. We call the first phase the \textit{pretest} phase, in which no experimental intervention is presented. The researchers collect the observed values in the pretest phase and use them to design the experiment. The second phase is called the \textit{test} phase, in which the researchers apply treatment to the treatment group according to the constructed design. 
For example, in the classical matched pairs design, geos are allocated into pairs, $\{(g_{k,+}, g_{k,-})\}_{k=1}^{N/2}$. Then, one of the geos in each pair is randomly assigned to the treatment group while the other one is assigned to the control group.
%Our proposed supergeo design is a natural generalization of the matched pairs design.



An alternative estimator that is often more precise than the empirical estimator is the \emph{trimmed match estimator} from \citet{chen2022robust}. This estimation procedure amounts to selecting the subsets $\mathcal{T}' \subseteq \mathcal{T}$ and $\mathcal{C}' \subseteq \mathcal{C}$ in order to obtain the most precise estimate of the form:\footnote{See \citet{chen2022robust} for the specifics of how the subsets $\mathcal{T}'$ and $\mathcal{C}'$ are selected.}

%\footnote{We remark that trimming can also be done in the experimental design phase as described in \cite{chen2021trimmed}. But with the knowledge of the data generated in the experiments, trimming in the analysis phase is at least as good as trimming in the design phase, so in this paper we only compare our supergeo design with the trimmed match estimator that performs trimming in analysis.} they trim the pairs that are not well-matched according to the experiment data, and for the remaining treatment geos $\mathcal{T}' \subseteq \mathcal{T}$ and control geos $\mathcal{C}' \subseteq \mathcal{C}$, compute
\begin{equation}\label{eq:theta_hat_trim}
\hat{\theta}^{\mathrm{trim}} := \frac{\sum_{g \in \mathcal{T}'} R_g - \sum_{g \in \mathcal{C}'} R_{g}}{\sum_{g \in \mathcal{T}'} S_g - \sum_{g \in \mathcal{C}'} S_{g}}.
\end{equation}
%The trimmed match estimator can be easily extended to our supergeo design, and in our evaluations we will compare the supergeo design with the matched pairs design under both the empirical estimator and the trimmed match estimator.
%\Shunhua{I added a description of matched pairs design and trimmed match estimator here. One question: Would readers be confused about why we only optimize the variance of $\hat{\theta}$ instead of $\hat{\theta}^{\mathrm{trim}}$? We could add something like our goal is to show supergeo design + empirical estimator is as good as trimmed match estimator.}\Cliff{I think the way you wrote this is good}

\paragraph{Model assumptions.}
We follow \cite{chen2022robust} and make a number of assumptions that facilitate a formal analysis of alternative experimental design and analysis procedures.

%Since we are interested in the ratio between responses and spends, which is inherently a linear quantity, the first and the most important assumption states that the observed response $R_g$ is linearly increasing with respect to the controlled variable $S_g$. 
\begin{assumption}[Linear response model]\label{ass:linear}
For each $g \in \mathcal{G}$ the \emph{uninfluenced response},\footnote{Corresponding to the response under zero advertising spend.} $Z_g$, does not depend on treatment assignment, and $R_g$ depends on $S_g$ linearly:
\begin{align*}
R_g = Z_g + \theta_g \cdot S_g.
\end{align*}
\end{assumption}

\noindent The next assumption stipulates that the total difference in spend between the treatment and control units is unaffected by the treatment assignment. It captures the real-life scenario in which the researcher has a budgetary constraint when conducting the experiment. It also simplifies the calculation of the variance of $\hat{\theta}$.
\begin{assumption}[Fixed budget]\label{ass:fixed_budget}
There is a fixed experimental budget $B$ so that
\[
\sum_{g \in \mathcal{T}} S_g - \sum_{g \in \mathcal{C}} S_{g} = B.
\]
\end{assumption}

% Finally, for simplicity we will first consider the case where all unit-level $\theta_g$'s are the same, and later extend to heterogeneous $\theta_g$'s.
% \begin{assumption}[Homogeneous $\theta_g$]\label{ass:homogeneous}
% For all $g \in \mathcal{G}$, $\theta_g = \theta$.
% \end{assumption}

%\Shunhua{TODO: add a more detailed description of trimmed match here.}




\paragraph{Supergeo design.}
%We propose the supergeo experimental design, which is a generalization of the standard matched pairs design. \Aiyou{Duplicated with the intro 'Supergeo matching design'; Shall we remove?}
%\Shunhua{The purpose of this paragraph is to introduce the formal notations $\{(G_{k,+}, G_{k,-})\}_{k=1}^K$ and $A_k$. I could try to shorten it.}

The supergeo experimental design proposed in this paper consists of $K$ \emph{supergeo pairs} $\{(G_{k,+}, G_{k,-})\}_{k=1}^K$ where $G_{k,+}, G_{k,-} \subset \mathcal{G}$ are nonempty sets of geos which we call supergeos. Note that if we restrict all supergeos to have size one, we recover the standard matched pairs design. %The optimal supergeo design is the design that minimizes the bias and the variance of the empirical estimate $\hat{\theta}$. In the next two sections we will analyze the bias and the variance of $\hat{\theta}$. %and in Section~\ref{sec:supergeo_algo} we propose an algorithm that uses mixed integer programming (MIP) to compute the optimal supergeo design using the pretest data.


In each supergeo pair we randomly assign one of the supergeos to the treatment group and the other one to the control group. %implying that all geos that belong to the treated supergeo are treated and, similarly, all geos that belong to the control supergeo are not treated. \Shunhua{The part after ``implying'' seems redundant to me.} 
Let $A_k \in \{\pm 1\}$ for $k=1,\dots,K$ be $i.i.d.$ random sign variables independent from the rest of the data. Let $A_k=1$ with probability $1/2$ indicating that $G_{k,+}$ is treated and $A_k=-1$ with probability $1/2$ indicating that $G_{k,-}$ is treated. 
%Then, the researchers conduct the experiment and apply the treatment to the treatment group, i.e., they design the control variables $S_g$ to be different for the treatment and the control group. In this paper we consider \textit{heavy up} experiments that increase $S_g$ for geos in the treatment group, and keep $S_g$ the same for geos in the control group.\footnote{The methods of this paper can be easily extended to another commonly used \emph{go dark} experiment which sets treatment $S_g$'s to zeroes.} Lastly, the researchers collect the observed response variables in the test phase and generate the reports including the empirical estimate $\hat{\theta}$ and confidence intervals.

For convenience, for a supergeo $G \subset \mathcal{G}$, we define the spend and response of $G$ as $S_{G} := \sum_{g \in G} S_g$ and $R_{G} := \sum_{g \in G} R_g$. Similarly, we define the uninfluenced response of $G$ as $Z_{G} := \sum_{g \in G} Z_g$. 


\subsection{Homogeneous $\theta_g$}\label{sec:homo_model}
We start by computing the bias and variance of the empirical estimator, $\hat{\theta}$, under the assumption that all geos respond to treatment in the same way.
\begin{assumption}[Homogeneous $\theta_g$]\label{ass:homogeneous}
For all $g \in \mathcal{G}$, $\theta_g = \theta$.
\end{assumption}

\noindent Note that the response difference between treatment and control of the $k$-th supergeo pair $(G_{k_+}, G_{k_-})$ can be expressed as $A_k (R_{G_{k,+}} - R_{G_{k,-}})$.
% we can establish
% \begin{align*}
%     \hat{\theta} =&\,\frac{\sum_{g \in \mathcal{T}} R_g - \sum_{g \in \mathcal{C}} R_{g}}{\sum_{g \in \mathcal{T}} S_g - \sum_{g \in \mathcal{C}} S_{g}}\\ %\frac{\sum_{k} R_{k,t} - R_{k,c}}{\sum_{k} C_{k,t} - C_{k,c}}\\
%     =&\, \frac{\sum_{k} A_k (R_{G_{k,+}} - R_{G_{k,-}})}{\sum_{k} A_k (S_{G_{k,+}} - S_{G_{k,-}})} \\
%     \stackrel{(a)}{=}&\, \theta +  \frac{\sum_{k} A_k (Z_{G_{k,+}} - Z_{G_{k,-}})}{\sum_{k} A_k (S_{G_{k,+}} - S_{G_{k,-}})} \\
%     \stackrel{(b)}{=}&\, \theta +  \frac{1}{B} \sum_{k} A_k (Z_{G_{k,+}} - Z_{G_{k,-}}),
% \end{align*}
% where step (a) follows from the linear model and the homogeneous $\theta$ assumption, and step (b) follows from the fixed budget assumption. 
Assumptions~\ref{ass:linear} and~\ref{ass:fixed_budget} imply that %\citep[see][for the derivation]{chen2021trimmed} \Shunhua{I would remove this reference since the TM paper doesn't explicitly have this formula. I think it's ok to directly present this formula here.}\Nick{Sounds good.}
\begin{align*}
     \hat{\theta} & =  \theta +  \frac{1}{B} \sum_{k} A_k (Z_{G_{k,+}} - Z_{G_{k,-}}).
\end{align*}
Since $\{A_k: k=1,\dots,K\}$ are $i.i.d.$~zero-mean random variables that are independent from the rest of the variables, we conclude that $\hat{\theta}$ is an \emph{unbiased} estimator of $\theta$: $\E[\hat{\theta}] = \theta$. The above equation also implies that the variance of $\hat{\theta}$ (note that the randomness is over the $A_k$'s) is:
%\Cliff{At this point the choice of the supergeos is irrelevant to the computation of $\hat{\theta}$, it only really matters whether a geo is in control or treatment.  We should point out that we are aware of this, or someone may stop reading because it looks trivial.}\Shunhua{The treatment and control groups are determined by the supergeo pairs + random assignment, so $\hat{\theta}$ would depend on the supergeos. Should I emphasize that the expectation and variance are over the randomness of the $A_k$'s?}\Cliff{Yes.  My point was that in the end, once you made the random choices, it doesn't matter what the supergeo's are.  But since we say we choose the supergeos first, I think just pointing out that the randomness is over the A's is good.}\Shunhua{Done.}
\begin{align}
    %\E[\hat{\theta}] =\,& \theta,  \notag \\
    \Var[\hat{\theta}] =\,& \frac{1}{B^2}\sum_{k}(Z_{G_{k,+}} - Z_{G_{k,-}})^2. \label{eq:variance}
\end{align}
The goal of our experimental design procedure is to find supergeo pairs that minimize $\sum_{k}(Z_{G_{k,+}} - Z_{G_{k,-}})^2$. Note that without a constraint on the maximum size of a supergeo pair, the optimal way to minimize the variance is to split all geos into a single supergeo pair $({G_{+}}, {G_{-}})$ with minimum difference $|Z_{G_{+}} - Z_{G_{-}}|$. We will add a size constraint that is important for several reasons that will be discussed in Section~\ref{sec:supergeo_algo}.
%\Cliff{Similar to last comment.  At this point we see why the supergeos matter, but the minimum variance comes from having just 2 supergeos.  We should point out that we are aware of this and will be adding other constraints.}\Shunhua{Done.}



\subsection{Heterogeneous $\theta_g$}\label{sec:hetero_model}
%\section{Extension to Heterogeneous Model}
In practice, it is quite possible that different geos respond to treatment differently. This leads us to a model in which Assumption~\ref{ass:homogeneous} is abandoned. 
%Assume that the linear model of Assumption~\ref{ass:linear} also holds for the potential outcomes, then
Note that the linearity Assumption~\ref{ass:linear} implies that
%Define $\Delta S_g := S_g^{(t)} - S_g^{(c)}$, then we have
\begin{align*}
    \theta = &~ \frac{\sum_g R_g^{(t)} - \sum_g R_g^{(c)}}{\sum_g S_g^{(t)} - \sum_g S_g^{(c)}}
    = \frac{\sum_g \theta_g \cdot (S_g^{(t)} - S_g^{(c)})}{\sum_g (S_g^{(t)} - S_g^{(c)})}.
\end{align*}
Therefore, the ratio of interest, $\theta$, depends on the exact way in which we change the controlled variable $S_g$ under the treatment and control conditions. 
A natural choice is to increase all treatment spends proportionally to the original (pre-experimental) spends and leave the control spends unaffected.%We make the following stronger assumption.
\begin{assumption}[Proportional spend]\label{ass:ideal_model}%\Aiyou{What about 'Proportional spend' instead of 'Ideal model'}
Suppose that each geo $g$ has the initial spend $\overline{S}_g$. In the experiment, if $g$ is in the control group, then $S_g^{(c)} = \overline{S}_g$. If $g$ is in the treatment group, then $S_g^{(t)} = \overline{S}_g + \Delta S_g$, where $\Delta S_g = r \cdot \overline{S}_g$. Moreover, the total increase in the spend satisfies the fixed budget assumption: $r\cdot\sum_{g\in\mathcal{T}}\overline{S}_g=B.$
\end{assumption}
\noindent Under this assumption, since we always increase the treatment spend proportionally to $\overline{S}_g$, we have
\begin{equation}\label{eq:theta_hetero_simplify}
\theta = \frac{\sum_g \theta_g \cdot \overline{S}_g}{\sum_g \overline{S}_g}.
\end{equation}
If we conduct the experiment and compute the empirical estimator $\hat{\theta}$ in the same way as before, it is no longer unbiased for $\theta$. Using the linear model assumption and the fixed budget assumption, we have
\begin{align}\label{eq:hetero_error}
    \hat{\theta} 
    %=&~\frac{\sum_{g \in \mathcal{T}} (Z_g + \theta_g (\overline{S}_g + \Delta S_g)) - \sum_{g \in \mathcal{C}} (Z_{g} + \theta_{g} \overline{S}_{g})}{\sum_{g \in \mathcal{T}} (\overline{S}_g + \Delta S_g) - \sum_{g \in \mathcal{C}} \overline{S}_{g}} \notag \\
    %= &~ \theta + \frac{1}{B} \cdot \sum_{g \in \mathcal{T}} (Z_g + (\theta_g - \theta) \cdot (\overline{S}_g + \Delta S_g)) \notag \\ 
    %&~ - \frac{1}{B} \cdot \sum_{g \in \mathcal{C}} (Z_{g} + (\theta_{g} - \theta) \cdot \overline{S}_{g}) \notag \\
    = \theta & + \frac{1}{B} \sum_{k} A_k (Z_{G_{k,+}} - Z_{G_{k,-}}) \notag \\
    & + \frac{1}{B} \Big( \sum_{g \in \mathcal{T}} (\theta_g - \theta) \overline{S}_g - \sum_{g \in \mathcal{C}} (\theta_{g} - \theta) \overline{S}_{g} \Big) \notag \\
    & + \frac{1}{B} \sum_{g \in \mathcal{T}} (\theta_g - \theta) \Delta S_g.
\end{align}
%where the second equality follows from the fixed budget assumption and the third follows from the definition of $A_k \in \{\pm 1\}$.
%\Shunhua{I shortened this equation here.}

\noindent We denote the three error terms in the above equation as $err_1$, $err_2$, and $err_3$. %Next we analyze them one by one, and give an explanation why sometimes it's not a good idea to discard data as in the trimmed match estimator.

%\begin{itemize}
%\item 
$err_1$: The first error term corresponds to the training error which is the same as in the homogeneous model. Since each $A_k$ is uniformly random in $\{-1,1\}$,
\[
\E[err_1] = \E\Big[\sum_{k} A_k (Z_{G_{k,+}} - Z_{G_{k,-}})\Big] = 0.
\]
The magnitude of this error term is small if the (super)geo pairs are well-matched. It can be reduced further by trimming some of the poorly matched pairs. 

%\item 
$err_2$: The second error term measures the difference between the treatment and control groups in terms of the within-group heterogeneity in $\theta_g$'s. Since each geo is either in the treatment group or the control group with probability $1/2$, we have
\begin{align*}
&~ \E[err_2]
= \E\Big[ \sum_{g \in \mathcal{T}} (\theta_g - \theta) \overline{S}_g - \sum_{g \in \mathcal{C}} (\theta_{g} - \theta) \overline{S}_{g} \Big] \\
= &~ \sum_{g \in \mathcal{G}} \E\Big[\mathbf{1}_{g \in \mathcal{T}} \cdot (\theta_g - \theta) \overline{S}_g - \mathbf{1}_{g \in \mathcal{C}} \cdot (\theta_g - \theta) \overline{S}_g \Big]
= 0.
\end{align*}
The second error term has zero mean for both the supergeo design and the matched pairs design. It remains zero when either all pairs are used or some are removed to improve the matching quality.% the empirical estimator or the trimmed match estimator. The trimmed match estimator could potentially decrease the magnitude of this error term since it removes some geos. %While for the supergeo design, since we group geos into supergeos according to $Z_g$'s which are independent of $(\theta_g - \theta) \overline{S}_g$, it is not helpful to reduce the magnitude of this error term.

%\item 
$err_3$: The third error term measures the degree of heterogeneity in $\theta_g$'s within the treatment group. The expectation of this term is approximately zero when all geos are included in the experiment. However, this term could induce a bias if some geos are excluded.
%We are going to show that the expectation of this term can be reduced by including all geos in the experiment. However, this term could induce a large bias if some geos are excluded.
%\Shunhua{I rephrased this sentence a bit.}

By Assumption \ref{ass:fixed_budget}, %$\Delta S_g \propto \overline{S}_g$, 
we have
\begin{equation*}%\label{eq:err3_simplify}
err_3 = \sum_{g \in \mathcal{T}} (\theta_g - \theta) \cdot \Delta S_g = r \cdot \sum_{g \in \mathcal{T}} (\theta_g - \theta) \cdot \overline{S}_g,
\end{equation*}
where $r$ is a random variable that depends on the specific treatment assignment in order to satisfy the fixed budget assumption.%\footnote{It has to vary between treatment assignments in order to satisfy the fixed budget assumption.}\Shunhua{I suggest to put this footnote in the main text.} \Aiyou{we already say it depends on the specific treatment assignment, so the footnote looks more like a duplicate? If so, could remove.}
%Since we also made the fixed budget assumption that $\sum_{g \in \mathcal{T}} \Delta S_g = B$, we have $r = \frac{B}{\sum_{g \in \mathcal{T}} \overline{S}_g}$.
%\begin{itemize}
%\item 

\paragraph{If all geos are included in the experiment.} The key observation is that since $\theta = \sum_g \theta_g \cdot \overline{S}_g / \sum_g \overline{S}_g$,
\begin{equation}\label{eq:hetero}\vspace{-0.2cm}
\sum_g (\theta_g - \theta) \cdot \overline{S}_g = 0.
\end{equation}
Since all geos are included in the experiment, $\sum_{g \in \mathcal{T}} \overline{S}_g \approx 0.5 \cdot \sum_{g \in \mathcal{G}} \overline{S}_g$, so that $r \approx r_0 := 2B/\sum_g \overline{S}_g$. Thus,
\begin{align*}
\E[err_3] = &~ \E\Big[ r \cdot \sum_{g \in \mathcal{T}} (\theta_g - \theta) \cdot \overline{S}_g \Big] \\
\approx &~ r_0 \cdot \E\Big[ \sum_{g \in \mathcal{T}} (\theta_g - \theta) \cdot \overline{S}_g \Big] \\
= &~ r_0 \cdot \sum_g \E[\mathbf{1}_{g \in \mathcal{T}} 
\cdot (\theta_g - \theta) \cdot \overline{S}_g] = 0,
\end{align*}
where the last equality follows from \eqref{eq:hetero} and the fact that each geo has probability $1/2$ to fall into the treatment group.

%\item 
\paragraph{If some geos are excluded.} In this case, some geos have zero probability to be included in the treatment group and we no longer have $\E[\sum_{g \in \mathcal{T}} (\theta_g - \theta) \cdot \overline{S}_g] = 0$. The bias induced by $err_3$ is especially large when the excluded geos have extra large or extra small values of $\theta_g$ since those differ the most from the weighted average value, $\theta$. %ese geos contribute a lot to the total sum. And this is exactly the case of the trimmed match estimator where it often excludes large geos.%$(\theta_g - \theta) \cdot \overline{S}_g$
%\end{itemize}
%\end{itemize}

While trimming poorly matched pairs can reduce the variance of the resulting estimator, it can also induce a substantial bias when $\theta_g$'s of the removed geos differ from the quantity of interest, $\theta$. We provide specific examples illustrating this issue in Section~\ref{sec:eval}. %In conclusion, while we can improve the vanilla matched pairs design by using either the supergeo design or the trimmed match estimator, it may not be a good idea to trim pairs when the $(\theta_g - \theta) \cdot \overline{S}_g$ values are very non-uniform.
%would greatly affect the third error term if it excludes geos whose $(\theta_g - \theta) \cdot \overline{S}_g$ contributes a lot to the total sum.
%\Shunhua{Please polish this sentence. We may not want to use trimmed match when some $(\theta_g - \theta) \cdot \overline{S}_g$ are outliers, and TM trims them.}